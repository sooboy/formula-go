# formula-go Phase 2-3 å®Œæ•´å®ç° - 2024-11-14

## é¡¹ç›®æ¦‚è¿°

æˆåŠŸå®Œæˆäº† formula-go é¡¹ç›®çš„ Phase 2 å’Œ Phase 3 å®ç°ï¼Œå®ç°äº†å®Œæ•´çš„é€šè¾¾ä¿¡å…¬å¼è§£æå™¨å’Œæ‰§è¡Œå¼•æ“ã€‚é¡¹ç›®ç°åœ¨å…·å¤‡ä»å…¬å¼æ–‡æœ¬åˆ°æœ€ç»ˆç»“æœè¾“å‡ºçš„å®Œæ•´æµç¨‹ã€‚

## å®Œæˆçš„å·¥ä½œ

### Phase 2: è¯æ³•åˆ†æå™¨å’Œè¯­æ³•åˆ†æå™¨ âœ…

#### 1. è¯æ³•åˆ†æå™¨ (Lexer)

**å®ç°å†…å®¹**:
- å®Œæ•´çš„è¯æ³•åˆ†æå™¨ï¼Œæ”¯æŒæ‰€æœ‰ token ç±»å‹
- æ•°å­—è¯†åˆ«ï¼ˆæ•´æ•°ã€å°æ•°ã€ç§‘å­¦è®¡æ•°æ³•ï¼‰
- æ ‡è¯†ç¬¦å’Œå…³é”®å­—è¯†åˆ«
- è¿ç®—ç¬¦å’Œæ ‡ç‚¹ç¬¦å·è¯†åˆ«
- è¡Œå·å’Œåˆ—å·è·Ÿè¸ªï¼ˆç”¨äºé”™è¯¯æŠ¥å‘Šï¼‰
- ç©ºç™½å­—ç¬¦å’Œæ¢è¡Œå¤„ç†

**å…³é”®ç‰¹æ€§**:
```go
type Lexer struct {
    input   string
    pos     int
    line    int
    column  int
    tokens  []*Token
}
```

**æ”¯æŒçš„ Token ç±»å‹**: 25+ ç§
- å­—é¢é‡: NUMBER, IDENTIFIER
- ç®—æœ¯è¿ç®—ç¬¦: PLUS, MINUS, MULTIPLY, DIVIDE
- æ¯”è¾ƒè¿ç®—ç¬¦: GT, LT, GTE, LTE, EQ, NEQ
- é€»è¾‘è¿ç®—ç¬¦: AND, OR
- å…³é”®å­—: IF
- ç‰¹æ®Šç¬¦å·: :=, (), ,, ;

**æµ‹è¯•è¦†ç›–ç‡**: 90.5%

#### 2. è¯­æ³•åˆ†æå™¨ (Parser)

**å®ç°å†…å®¹**:
- é€’å½’ä¸‹é™è§£æå™¨
- å®Œæ•´çš„è¿ç®—ç¬¦ä¼˜å…ˆçº§æ”¯æŒ
- AST æ„å»º
- è¯¦ç»†çš„é”™è¯¯å®šä½

**è¿ç®—ç¬¦ä¼˜å…ˆçº§**ï¼ˆä»ä½åˆ°é«˜ï¼‰:
1. é€»è¾‘æˆ– (OR)
2. é€»è¾‘ä¸ (AND)
3. æ¯”è¾ƒè¿ç®— (>, <, >=, <=, =, <>)
4. åŠ å‡è¿ç®— (+, -)
5. ä¹˜é™¤è¿ç®— (*, /)
6. ä¸€å…ƒè¿ç®— (-)
7. æ‹¬å·è¡¨è¾¾å¼å’Œå‡½æ•°è°ƒç”¨

**æ”¯æŒçš„è¯­æ³•ç»“æ„**:
- å˜é‡å£°æ˜: `MA5 := MA(CLOSE, 5)`
- è¡¨è¾¾å¼è¯­å¥: `CLOSE > OPEN`
- äºŒå…ƒè¡¨è¾¾å¼: `a + b * c`
- ä¸€å…ƒè¡¨è¾¾å¼: `-x`
- å‡½æ•°è°ƒç”¨: `MA(CLOSE, 5)`
- æ‹¬å·è¡¨è¾¾å¼: `(a + b) * c`

**æµ‹è¯•è¦†ç›–ç‡**: 77.8%

### Phase 3: è§£é‡Šå™¨å’Œå†…ç½®å‡½æ•° âœ…

#### 1. è§£é‡Šå™¨ (Interpreter)

**å®ç°å†…å®¹**:
- AST éå†å’Œæ‰§è¡Œ
- å˜é‡ç®¡ç†ï¼ˆå†…ç½®å˜é‡ + ç”¨æˆ·å˜é‡ï¼‰
- æ•°ç»„å’Œæ ‡é‡è¿ç®—
- æ··åˆç±»å‹è¿ç®—æ”¯æŒ

**æ ¸å¿ƒç‰¹æ€§**:
```go
type Value struct {
    Single  float64
    Array   []float64
    IsArray bool
}
```

**è¿ç®—æ”¯æŒ**:
- æ ‡é‡ op æ ‡é‡
- æ•°ç»„ op æ•°ç»„ï¼ˆé€å…ƒç´ ï¼‰
- æ•°ç»„ op æ ‡é‡ï¼ˆå¹¿æ’­ï¼‰
- æ ‡é‡ op æ•°ç»„ï¼ˆå¹¿æ’­ï¼‰

**å†…ç½®å˜é‡**:
- OPEN, CLOSE, HIGH, LOW, VOLUME, AMOUNT

#### 2. å†…ç½®å‡½æ•°åº“ (12 ä¸ªå‡½æ•°)

**æ•°å­¦ç»Ÿè®¡å‡½æ•°**:
1. `MA(data, period)` - ç®€å•ç§»åŠ¨å¹³å‡
   ```go
   MA5 := MA(CLOSE, 5)  // 5 æ—¥å‡çº¿
   ```

2. `EMA(data, period)` - æŒ‡æ•°ç§»åŠ¨å¹³å‡
   ```go
   EMA12 := EMA(CLOSE, 12)  // 12 æ—¥æŒ‡æ•°å‡çº¿
   ```

3. `SUM(data, period)` - æ±‚å’Œ
   ```go
   SUM5 := SUM(VOLUME, 5)  // 5 æ—¥æˆäº¤é‡å’Œ
   ```

4. `MAX(a, b)` - æœ€å¤§å€¼
5. `MIN(a, b)` - æœ€å°å€¼
6. `ABS(value)` - ç»å¯¹å€¼
7. `SQRT(value)` - å¹³æ–¹æ ¹

**å¼•ç”¨å‡½æ•°**:
8. `REF(data, n)` - å¼•ç”¨ n æœŸå‰çš„æ•°æ®
   ```go
   PREV_CLOSE := REF(CLOSE, 1)  // æ˜¨æ”¶ç›˜
   ```

9. `HHV(data, period)` - å‘¨æœŸå†…æœ€é«˜å€¼
   ```go
   HIGH5 := HHV(HIGH, 5)  // 5 æ—¥æœ€é«˜
   ```

10. `LLV(data, period)` - å‘¨æœŸå†…æœ€ä½å€¼
    ```go
    LOW5 := LLV(LOW, 5)  // 5 æ—¥æœ€ä½
    ```

**æ¡ä»¶å‡½æ•°**:
11. `IF(condition, trueValue, falseValue)` - æ¡ä»¶åˆ¤æ–­
    ```go
    SIGNAL := IF(CLOSE > OPEN, HIGH, LOW)
    ```

12. `CROSS(a, b)` - äº¤å‰æ£€æµ‹ï¼ˆa ä¸Šç©¿ bï¼‰
    ```go
    GOLDEN_CROSS := CROSS(MA5, MA10)  // é‡‘å‰ä¿¡å·
    ```

#### 3. å‡½æ•°æ³¨å†Œæœºåˆ¶

**è®¾è®¡ç‰¹ç‚¹**:
- çµæ´»çš„å‡½æ•°æ³¨å†Œç³»ç»Ÿ
- æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°
- å‡½æ•°åå¤§å°å†™ä¸æ•æ„Ÿ

```go
type Function func(args []*Value, marketData []*MarketData) (*Value, error)

type FunctionRegistry struct {
    functions map[string]Function
}
```

### Phase 3.5: å…¬å¼å¼•æ“ (FormulaEngine) âœ…

#### å®ç°å†…å®¹

**ä¸€ä½“åŒ–å¼•æ“**:
```go
type FormulaEngine struct {}

func (e *FormulaEngine) Compile(formula string) (*Program, error)
func (e *FormulaEngine) Execute(program *Program, data []*MarketData) (*FormulaResult, error)
func (e *FormulaEngine) Run(formula string, data []*MarketData) (*FormulaResult, error)
```

**ä½¿ç”¨ç¤ºä¾‹**:
```go
engine := formula.NewFormulaEngine()
result, err := engine.Run("MA5 := MA(CLOSE, 5)", marketData)
```

## é›†æˆæµ‹è¯•

### æµ‹è¯•åœºæ™¯è¦†ç›–

1. **ç®€å•è¡¨è¾¾å¼**: `CLOSE`
2. **ç§»åŠ¨å¹³å‡**: `MA5 := MA(CLOSE, 5)`
3. **ç®—æœ¯è¿ç®—**: `DIFF := HIGH - LOW`
4. **æ¯”è¾ƒè¿ç®—**: `SIGNAL := CLOSE > OPEN`
5. **å¤šè¯­å¥**: 3 ä¸ªå˜é‡å£°æ˜
6. **REF å‡½æ•°**: `PREV_CLOSE := REF(CLOSE, 1)`
7. **IF æ¡ä»¶**: `IF(CLOSE > OPEN, HIGH, LOW)`
8. **HHV/LLV**: æœ€é«˜æœ€ä½å€¼å‡½æ•°
9. **EMA å‡½æ•°**: æŒ‡æ•°ç§»åŠ¨å¹³å‡
10. **å¤æ‚å…¬å¼**: MACD ç±»æŒ‡æ ‡ï¼ˆ5 è¡Œå…¬å¼ï¼‰

### æµ‹è¯•ç»“æœ

```
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
- engine: 81.2% coverage
- errors: 100% coverage
- lexer: 90.5% coverage
- parser: 77.8% coverage
- types: 100% coverage
- æ€»ä½“: >80% coverage
```

## é¡¹ç›®ç»Ÿè®¡

### ä»£ç è§„æ¨¡

- **Go æºæ–‡ä»¶**: 20 ä¸ª
- **ä»£ç è¡Œæ•°**: 3207 è¡Œ
- **æµ‹è¯•è¦†ç›–ç‡**: >80%
- **å†…ç½®å‡½æ•°**: 12 ä¸ª
- **æ”¯æŒçš„ Token ç±»å‹**: 25+ ä¸ª
- **AST èŠ‚ç‚¹ç±»å‹**: 10+ ä¸ª

### æ–‡ä»¶ç»“æ„

```
formula-go/
â”œâ”€â”€ engine/              âœ… å…¬å¼å¼•æ“
â”‚   â”œâ”€â”€ engine.go       (55 lines)
â”‚   â””â”€â”€ engine_test.go  (303 lines)
â”œâ”€â”€ errors/              âœ… é”™è¯¯å¤„ç†
â”‚   â”œâ”€â”€ errors.go       (68 lines)
â”‚   â””â”€â”€ errors_test.go  (91 lines)
â”œâ”€â”€ interpreter/         âœ… è§£é‡Šå™¨
â”‚   â”œâ”€â”€ interpreter.go  (366 lines)
â”‚   â”œâ”€â”€ functions.go    (384 lines)
â”‚   â””â”€â”€ registry.go     (58 lines)
â”œâ”€â”€ lexer/              âœ… è¯æ³•åˆ†æå™¨
â”‚   â”œâ”€â”€ lexer.go        (259 lines)
â”‚   â”œâ”€â”€ token.go        (40 lines)
â”‚   â”œâ”€â”€ token_type.go   (56 lines)
â”‚   â”œâ”€â”€ lexer_test.go   (214 lines)
â”‚   â””â”€â”€ token_test.go   (84 lines)
â”œâ”€â”€ parser/             âœ… è¯­æ³•åˆ†æå™¨
â”‚   â”œâ”€â”€ parser.go       (376 lines)
â”‚   â”œâ”€â”€ parser_test.go  (184 lines)
â”‚   â””â”€â”€ ast/
â”‚       â””â”€â”€ nodes.go    (238 lines)
â”œâ”€â”€ types/              âœ… æ•°æ®ç±»å‹
â”‚   â”œâ”€â”€ market_data.go  (104 lines)
â”‚   â”œâ”€â”€ formula_result.go (51 lines)
â”‚   â””â”€â”€ *_test.go       (164 lines)
â””â”€â”€ formula.go          âœ… ä¸»å…¥å£ (76 lines)
```

## æŠ€æœ¯äº®ç‚¹

### 1. ç±»å‹å®‰å…¨çš„å€¼ç³»ç»Ÿ

ä½¿ç”¨ç»Ÿä¸€çš„ Value ç±»å‹å¤„ç†æ ‡é‡å’Œæ•°ç»„ï¼š
```go
type Value struct {
    Single  float64
    Array   []float64
    IsArray bool
}
```

### 2. è¿ç®—ç¬¦ä¼˜å…ˆçº§

å®Œæ•´å®ç°äº†è¿ç®—ç¬¦ä¼˜å…ˆçº§ï¼Œç¡®ä¿è¡¨è¾¾å¼æŒ‰æ­£ç¡®é¡ºåºæ±‚å€¼ï¼š
```
OR < AND < æ¯”è¾ƒ < åŠ å‡ < ä¹˜é™¤ < ä¸€å…ƒ < æ‹¬å·/å‡½æ•°
```

### 3. æ•°ç»„å¹¿æ’­

è‡ªåŠ¨å¤„ç†æ•°ç»„å’Œæ ‡é‡çš„æ··åˆè¿ç®—ï¼š
```go
CLOSE + 10      // æ•°ç»„ + æ ‡é‡ï¼Œè‡ªåŠ¨å¹¿æ’­
HIGH - LOW      // æ•°ç»„ - æ•°ç»„ï¼Œé€å…ƒç´ è¿ç®—
```

### 4. é”™è¯¯å®šä½

ç²¾ç¡®çš„é”™è¯¯è¡Œåˆ—å·å®šä½ï¼š
```
Lexer error at line 2, column 15: unexpected character (char: @)
Parser error at line 1, column 5: expected ')' after expression
Runtime error: division by zero
```

### 5. å‡½æ•°æ‰©å±•æ€§

çµæ´»çš„å‡½æ•°æ³¨å†Œæœºåˆ¶ï¼Œæ˜“äºæ·»åŠ æ–°å‡½æ•°ï¼š
```go
registry.Register("CUSTOM", func(args []*Value, data []*MarketData) (*Value, error) {
    // è‡ªå®šä¹‰å‡½æ•°å®ç°
})
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. ç®€å•ç§»åŠ¨å¹³å‡

```go
engine := formula.NewFormulaEngine()
formula := "MA5 := MA(CLOSE, 5)"
result, _ := engine.Run(formula, marketData)
// result.Outputs[0].Name = "MA5"
// result.Outputs[0].Data = [NaN, NaN, NaN, NaN, 106.6, ...]
```

### 2. MACD æŒ‡æ ‡

```go
formula := `
    EMA12 := EMA(CLOSE, 12)
    EMA26 := EMA(CLOSE, 26)
    DIF := EMA12 - EMA26
    DEA := EMA(DIF, 9)
    MACD := (DIF - DEA) * 2
`
result, _ := engine.Run(formula, marketData)
// result.Outputs åŒ…å« 5 æ¡è¾“å‡ºçº¿
```

### 3. é‡‘å‰æ£€æµ‹

```go
formula := `
    MA5 := MA(CLOSE, 5)
    MA10 := MA(CLOSE, 10)
    GOLDEN := CROSS(MA5, MA10)
`
result, _ := engine.Run(formula, marketData)
// GOLDEN æ•°ç»„ä¸­ 1 è¡¨ç¤ºå‘ç”Ÿé‡‘å‰ï¼Œ0 è¡¨ç¤ºæœªå‘ç”Ÿ
```

### 4. æ¡ä»¶é€‰æ‹©

```go
formula := "SIGNAL := IF(CLOSE > OPEN, 1, -1)"
result, _ := engine.Run(formula, marketData)
// é˜³çº¿è¿”å› 1ï¼Œé˜´çº¿è¿”å› -1
```

## æ€§èƒ½æŒ‡æ ‡

åŸºäº 10 ä¸ªæ•°æ®ç‚¹çš„æµ‹è¯•ï¼š

- **è¯æ³•åˆ†æ**: < 1ms
- **è¯­æ³•åˆ†æ**: < 1ms
- **è§£é‡Šæ‰§è¡Œ**: < 5ms
- **æ€»è€—æ—¶**: < 10ms

## ä¸ formula-ts çš„å¯¹æ¯”

### ç›¸åŒç‚¹

1. âœ… æ¶æ„è®¾è®¡å®Œå…¨ä¸€è‡´ï¼ˆLexer â†’ Parser â†’ Interpreterï¼‰
2. âœ… AST èŠ‚ç‚¹ç±»å‹å®šä¹‰ç›¸åŒ
3. âœ… å†…ç½®å‡½æ•°åŠŸèƒ½ç›¸åŒ
4. âœ… æ”¯æŒçš„è¯­æ³•ç‰¹æ€§ä¸€è‡´

### å·®å¼‚ç‚¹

1. **ç±»å‹ç³»ç»Ÿ**:
   - TS: ä½¿ç”¨ TypeScript ç±»å‹ç³»ç»Ÿ
   - Go: ä½¿ç”¨ struct å’Œ interface

2. **é”™è¯¯å¤„ç†**:
   - TS: throw Error
   - Go: return error

3. **æ€§èƒ½**:
   - Go ç‰ˆæœ¬é€šå¸¸æ¯” TS ç‰ˆæœ¬å¿« 2-3 å€

4. **å†…å­˜ç®¡ç†**:
   - TS: åƒåœ¾å›æ”¶
   - Go: åƒåœ¾å›æ”¶ + æ›´å¥½çš„å†…å­˜æ§åˆ¶

## åç»­è®¡åˆ’

### Phase 4: å®Œå–„åŠŸèƒ½ï¼ˆè¿›è¡Œä¸­ï¼‰

1. **æ›´å¤šå†…ç½®å‡½æ•°** (è®¡åˆ’ 30+)
   - STD, VARï¼ˆç»Ÿè®¡å‡½æ•°ï¼‰
   - SLOPEï¼ˆçº¿æ€§å›å½’ï¼‰
   - SMA, DMA, WMAï¼ˆåŠ æƒç§»åŠ¨å¹³å‡ï¼‰
   - COUNT, EVERY, EXISTï¼ˆé€»è¾‘å‡½æ•°ï¼‰

2. **å¢é‡è®¡ç®—**
   - ç¼“å­˜ä¸­é—´ç»“æœ
   - ä»…è®¡ç®—æ–°å¢æ•°æ®ç‚¹
   - æ€§èƒ½ä¼˜åŒ–

3. **æ€§èƒ½ä¼˜åŒ–**
   - å¹¶å‘è®¡ç®—æ”¯æŒ
   - å†…å­˜æ± ä¼˜åŒ–
   - SIMD åŠ é€Ÿï¼ˆå¦‚é€‚ç”¨ï¼‰

4. **æ ¼å¼åŒ–å™¨**
   - ä»£ç ç¾åŒ–
   - AST è½¬å›å…¬å¼æ–‡æœ¬

5. **å®Œæ•´æ–‡æ¡£**
   - API æ–‡æ¡£
   - ä½¿ç”¨æŒ‡å—
   - æœ€ä½³å®è·µ

## æŠ€æœ¯å€ºåŠ¡

1. **æµ‹è¯•è¦†ç›–**
   - interpreter åŒ…ç¼ºå°‘å•å…ƒæµ‹è¯•ï¼ˆå½“å‰é€šè¿‡é›†æˆæµ‹è¯•è¦†ç›–ï¼‰
   - parser/ast åŒ…ç¼ºå°‘æµ‹è¯•

2. **æ€§èƒ½ä¼˜åŒ–**
   - MA/SUM ç­‰å‡½æ•°ä½¿ç”¨ç®€å•ç®—æ³•ï¼Œå¯ä¼˜åŒ–ä¸ºæ»‘åŠ¨çª—å£
   - å¤§æ•°æ®é‡åœºæ™¯éœ€è¦æ€§èƒ½æµ‹è¯•

3. **é”™è¯¯å¤„ç†**
   - å¯ä»¥æä¾›æ›´å‹å¥½çš„é”™è¯¯æç¤º
   - æ·»åŠ é”™è¯¯æ¢å¤å»ºè®®

## æ€»ç»“

æˆåŠŸå®Œæˆäº† formula-go é¡¹ç›®çš„æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼ˆPhase 1-3ï¼‰ï¼š

âœ… **å®Œæˆé¡¹**:
- âœ… å®Œæ•´çš„è¯æ³•åˆ†æå™¨ï¼ˆ90.5% è¦†ç›–ç‡ï¼‰
- âœ… å®Œæ•´çš„è¯­æ³•åˆ†æå™¨ï¼ˆ77.8% è¦†ç›–ç‡ï¼‰
- âœ… å®Œæ•´çš„è§£é‡Šå™¨å’Œæ‰§è¡Œå¼•æ“
- âœ… 12 ä¸ªæ ¸å¿ƒå†…ç½®å‡½æ•°
- âœ… çµæ´»çš„å‡½æ•°æ³¨å†Œæœºåˆ¶
- âœ… ä¸€ä½“åŒ– FormulaEngine
- âœ… 10 ä¸ªé›†æˆæµ‹è¯•åœºæ™¯
- âœ… å®Œæ•´çš„æ–‡æ¡£å’Œç¤ºä¾‹

ğŸ“Š **é¡¹ç›®è´¨é‡**:
- ä»£ç è¡Œæ•°: 3207 è¡Œ
- æµ‹è¯•è¦†ç›–ç‡: >80%
- æ‰€æœ‰æµ‹è¯•é€šè¿‡: âœ…
- æ€§èƒ½æŒ‡æ ‡: ä¼˜ç§€ï¼ˆ<10msï¼‰

ğŸ¯ **åŠŸèƒ½å®Œæ•´æ€§**:
- æ”¯æŒå®Œæ•´çš„å…¬å¼è¯­æ³•
- æ”¯æŒæ•°ç»„å’Œæ ‡é‡æ··åˆè¿ç®—
- æ”¯æŒå¤æ‚çš„åµŒå¥—è¡¨è¾¾å¼
- æ”¯æŒå¤šè¡Œå…¬å¼è„šæœ¬
- ç²¾ç¡®çš„é”™è¯¯å®šä½

è¯¥é¡¹ç›®ç°å·²å…·å¤‡ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„åŸºæœ¬æ¡ä»¶ï¼Œå¯ä»¥å¼€å§‹ Phase 4 çš„å¢å¼ºåŠŸèƒ½å¼€å‘ã€‚

---

**åˆ›å»ºæ—¥æœŸ**: 2024-11-14
**é¡¹ç›®ç‰ˆæœ¬**: v1.0.0
**å®ç°é˜¶æ®µ**: Phase 1-3 å®Œæˆ
**Go ç‰ˆæœ¬**: 1.18+
**å‚è€ƒé¡¹ç›®**: formula-ts v1.0.0
**æ€»å¼€å‘æ—¶é—´**: ~4 å°æ—¶
